# This is a simple example to demonstrate EPICS 7 and QSRV features
# The database simulates a rotating (unit) vector (testcircle:angle)
# The vector has cartesian coordinates testcircle:x and testcircle:y, as separate records.
# Using info tags, a group "testcircle" is generated from these  x and y (plus the angle, for cross-check)
# With CA one needs to open two monitors, one for testcircle:x and one for testcircle:y
# As these are transported separately over CA, there is no guarantee that x and y are synchronous.
# With PVA, testcircle is transported as one atomic unit and the synchronicity of x and y is guaranteed.
# rotation of the vector is controlled by:
# testcircle:step (step angle) and testcircle:period (rotation speed, or period in seconds)


record(ao, "testcircle:step") {
  field(VAL , "1.0")
  field(DRVL, "0.0")
  field(DRVH, "359")
  field(PINI, "YES")
}

record(ao, "testcircle:period") {
  field(VAL , "1.0")
  field(PINI, "YES")
  field(OUT , "testcircle:tick.ODLY NPP")
}

record(calcout, "testcircle:tick") {
  field(INPA,"testcircle:tick NPP")
  field(CALC,"A+1")
  field(ODLY, "1.0")
  field(OUT , "testcircle:angle.PROC CA") # loop
}

record(calc, "testcircle:angle") {
  field(PINI, "RUNNING") # bootstrap
  field(INPA, "testcircle:angle NPP")
  field(INPB, "testcircle:step NPP")
  field(INPD, "360")
  field(DESC, "Angle")
  field(EGU , "deg")
  field(LOLO, "45")
  field(LOW , "135")
  field(HIGH, "225")
  field(HIHI, "$(HIHIDEF=315)")
  field(LLSV, "MAJOR")
  field(LSV , "MINOR")
  field(HSV , "MINOR")
  field(HHSV, "MAJOR")
  field(CALC, "C:=A+B;(C>=D)?C-D:C")
  field(FLNK, "testcircle:x")
  field(PREC, "3")
  info(Q:group, {
        "testcircle":{
            +atomic:true,
            "value.angle":{+type:"plain", +channel:"VAL"}
        }
  })
}

record(calc, "testcircle:x") {
  field(INPA, "testcircle:angle NPP")
  field(CALC, "cos(A*PI/180)")
#  field(TSEL, "testcircle:angle.TIME")
  field(FLNK, "testcircle:y")
  field(PREC, "3")
  info(Q:group, {
        "testcircle":{
            "":{+type:"meta", +channel:"VAL"},
            "value.X":{+type:"plain", +channel:"VAL"}
        }
  })
}

record(calc, "testcircle:y") {
  field(INPA, "testcircle:angle NPP")
  field(CALC, "sin(A*PI/180)")
#  field(TSEL, "testcircle:angle.TIME")
  field(PREC, "3")
  field(FLNK, "testcircle:tick")
  info(Q:group, {
        "testcircle":{
            "value.Y":{+type:"plain", +channel:"VAL",+trigger: "*"}
        }
  })
}

record(longin,"pulseNumber")
{
  field(INP,"testcircle:tick CPP")
  field(TSEL, "testcircle:angle.TIME")
  info(Q:group, {
        "testcircle":{
          "timeStamp.userTag":{+type:"plain",+channel:"VAL"}
        }
    })

}

record(longin,"test_TSEL")
{
  field(INP,"testcircle:tick CPP")
  field(TSEL, {pva:{pv: "testcircle", field:"timeStamp", time:true}})
}

#record(longin,"test_TSEL")
#{
#  field(TSEL,"-2")
#  field(INP, {pva:{pv: "testcircle", field:"userTag", time:true, proc:CP}})
#}
